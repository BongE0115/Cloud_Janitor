---
# =============================================================================
# Zombie Pods Deployment for Cloud Janitor Testing
# These pods simulate low-usage workloads that Cloud Janitor should detect
# =============================================================================

# Create target namespace
- name: Create target-workloads namespace
  kubernetes.core.k8s:
    kubeconfig: "{{ kubeconfig }}"
    state: present
    definition:
      apiVersion: v1
      kind: Namespace
      metadata:
        name: target-workloads
        labels:
          purpose: cloud-janitor-target
          managed-by: ansible

# -----------------------------------------------------------------------------
# Zombie Deployment 1: Sleeping forever, doing nothing
# -----------------------------------------------------------------------------
- name: Deploy zombie-sleeper (idle pods)
  kubernetes.core.k8s:
    kubeconfig: "{{ kubeconfig }}"
    state: present
    definition:
      apiVersion: apps/v1
      kind: Deployment
      metadata:
        name: zombie-sleeper
        namespace: target-workloads
        labels:
          app: zombie-sleeper
          zombie-type: idle
      spec:
        replicas: "{{ zombie_sleeper_replicas | default(3) }}"
        selector:
          matchLabels:
            app: zombie-sleeper
        template:
          metadata:
            labels:
              app: zombie-sleeper
              zombie-type: idle
          spec:
            containers:
            - name: sleeper
              image: busybox:latest
              command: ["sleep", "infinity"]
              resources:
                requests:
                  cpu: "10m"
                  memory: "16Mi"
                limits:
                  cpu: "50m"
                  memory: "64Mi"

# -----------------------------------------------------------------------------
# Zombie Deployment 2: Completed job that never gets cleaned up
# -----------------------------------------------------------------------------
- name: Deploy zombie-completed (abandoned pods)
  kubernetes.core.k8s:
    kubeconfig: "{{ kubeconfig }}"
    state: present
    definition:
      apiVersion: apps/v1
      kind: Deployment
      metadata:
        name: zombie-completed
        namespace: target-workloads
        labels:
          app: zombie-completed
          zombie-type: completed
      spec:
        replicas: "{{ zombie_completed_replicas | default(2) }}"
        selector:
          matchLabels:
            app: zombie-completed
        template:
          metadata:
            labels:
              app: zombie-completed
              zombie-type: completed
          spec:
            containers:
            - name: done
              image: busybox:latest
              command: ["sh", "-c", "echo 'I finished my job but nobody cleaned me up' && sleep infinity"]
              resources:
                requests:
                  cpu: "5m"
                  memory: "8Mi"
                limits:
                  cpu: "20m"
                  memory: "32Mi"

# -----------------------------------------------------------------------------
# Zombie Pod 3: Forgotten test pod
# -----------------------------------------------------------------------------
- name: Deploy zombie-forgotten-test (forgotten test env)
  kubernetes.core.k8s:
    kubeconfig: "{{ kubeconfig }}"
    state: present
    definition:
      apiVersion: v1
      kind: Pod
      metadata:
        name: zombie-forgotten-test
        namespace: target-workloads
        labels:
          app: zombie-forgotten
          zombie-type: forgotten
          environment: test
      spec:
        containers:
        - name: forgotten
          image: nginx:alpine
          resources:
            requests:
              cpu: "10m"
              memory: "32Mi"
            limits:
              cpu: "100m"
              memory: "128Mi"

# -----------------------------------------------------------------------------
# Zombie Pod 4: Old development pod
# -----------------------------------------------------------------------------
- name: Deploy zombie-old-dev (stale dev env)
  kubernetes.core.k8s:
    kubeconfig: "{{ kubeconfig }}"
    state: present
    definition:
      apiVersion: v1
      kind: Pod
      metadata:
        name: zombie-old-dev
        namespace: target-workloads
        labels:
          app: zombie-old-dev
          zombie-type: stale
          environment: dev
      spec:
        containers:
        - name: old-app
          image: alpine:latest
          command: ["sh", "-c", "echo 'Old dev environment nobody uses' && sleep infinity"]
          resources:
            requests:
              cpu: "5m"
              memory: "16Mi"
            limits:
              cpu: "50m"
              memory: "64Mi"

# -----------------------------------------------------------------------------
# Summary
# -----------------------------------------------------------------------------
- name: Display zombie pods summary
  ansible.builtin.debug:
    msg: |
      ðŸ§Ÿ Zombie Pods Deployed to target-workloads namespace:
        - zombie-sleeper: {{ zombie_sleeper_replicas | default(3) }} replicas (idle)
        - zombie-completed: {{ zombie_completed_replicas | default(2) }} replicas (abandoned)
        - zombie-forgotten-test: 1 pod (forgotten test)
        - zombie-old-dev: 1 pod (stale dev)
      Total: {{ (zombie_sleeper_replicas | default(3) | int) + (zombie_completed_replicas | default(2) | int) + 2 }} pods
