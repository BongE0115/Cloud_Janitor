{
  "id": null,
  "uid": "cloud-janitor-dashboard",
  "title": "Cloud Janitor - logs dashboard",
  "refresh": "5s",
  "schemaVersion": 39,
  "templating": {
    "list": [
      {
        "name": "namespace",
        "type": "query",
        "label": "Namespace",
        "datasource": { "type": "loki", "uid": "Loki" },
        "definition": "label_values(namespace)",
        "query": "label_values(namespace)",
        "refresh": 2,
        "includeAll": true,
        "current": { "text": "default", "value": "default" }
      }
    ]
  },
  "panels": [
    {
      "type": "stat",
      "title": "잡아낸 좀비 숫자",
      "gridPos": { "h": 6, "w": 8, "x": 0, "y": 0 },
      "datasource": { "type": "loki", "uid": "Loki" },
      "targets": [
        {
          "expr": "count(kube_pod_status_phase{namespace=~\"$namespace\", pod=~\"zombie.*\")",
          "refId": "A"
        }
      ],
      "fieldConfig": {
        "defaults": { "color": { "mode": "fixed", "fixedColor": "orange" } }
      }
    },
    {
      "type": "stat",
      "title": "절약된 예상 비용 (Total Savings)",
      "gridPos": { "h": 6, "w": 8, "x": 8, "y": 0 },
      "datasource": { "type": "loki", "uid": "Loki" },
      "targets": [
        {
          "expr": "sum(count_over_time({namespace=~\"$namespace\", pod=~\"zombie.*\"} [$__range])) * 0.5",
          "refId": "A"
        }
      ],
      "fieldConfig": {
        "defaults": {
          "unit": "decusd",
          "color": { "mode": "fixed", "fixedColor": "green" }
        }
      }
    },
    {
      "type": "stat",
      "title": "좀비 파드 후보 (현재 작동 중)",
      "gridPos": { "h": 6, "w": 8, "x": 16, "y": 0 },
      "datasource": { "type": "prometheus", "uid": "Prometheus" },
      "targets": [
        {
          "expr": "count(kube_pod_status_phase{namespace=~\"$namespace\", phase=\"Running\", pod=~\"candidate.*\"})",
          "refId": "A"
        }
      ],
      "fieldConfig": {
        "defaults": { "color": { "mode": "fixed", "fixedColor": "red" } }
      }
    },
    {
      "type": "timeseries",
      "title": "관리 중인 Pod 개수 (Zombie / Candidate / Normal)",
      "gridPos": { "h": 8, "w": 24, "x": 0, "y": 6 },
      "datasource": { "type": "prometheus", "uid": "Prometheus" },
      "targets": [
        {
          "expr": "count(kube_pod_status_phase{namespace=~\"$namespace\", phase=\"Running\", pod=~\"zombie.*\"})",
          "legendFormat": "Zombie",
          "refId": "A"
        },
        {
          "expr": "count(kube_pod_status_phase{namespace=~\"$namespace\", phase=\"Running\", pod=~\"candidate.*\"})",
          "legendFormat": "Candidate",
          "refId": "B"
        },
        {
          "expr": "count(kube_pod_status_phase{namespace=~\"$namespace\", phase=\"Running\", pod!~\"zombie.*|candidate.*\"})",
          "legendFormat": "Normal",
          "refId": "C"
        }
      ],
      "fieldConfig": {
        "defaults": {
          "custom": {
            "drawStyle": "bars",
            "fillOpacity": 100,
            "lineWidth": 1,
            "gradientMode": "none",
            "stacking": { "mode": "normal", "group": "A" }
          }
        }
      }
    },
    {
      "type": "timeseries",
      "title": "네트워크 트래픽양 (Pod Network I/O)",
      "gridPos": { "h": 8, "w": 24, "x": 0, "y": 14 },
      "datasource": { "type": "prometheus", "uid": "Prometheus" },
      "targets": [
        {
          "expr": "sum by (pod) (irate(container_network_receive_bytes_total{namespace=~\"$namespace\"}[5m]))",
          "legendFormat": "{{pod}} IN",
          "refId": "A"
        },
        {
          "expr": "sum by (pod) (irate(container_network_transmit_bytes_total{namespace=~\"$namespace\"}[5m]))",
          "legendFormat": "{{pod}} OUT",
          "refId": "B"
        }
      ],
      "fieldConfig": { "defaults": { "unit": "binbps" } }
    },
    {
      "type": "logs",
      "title": "Janitor 활동 로그",
      "gridPos": { "h": 10, "w": 24, "x": 0, "y": 22 },
      "datasource": { "type": "loki", "uid": "Loki" },
      "targets": [
        {
          "expr": "{namespace=~\"$namespace\"} |~ \"zombie|deleted|cleanup\"",
          "refId": "A"
        }
      ],
      "options": { "showTime": true, "enableLogDetails": true }
    }
  ]
}
