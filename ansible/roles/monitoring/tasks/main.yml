# Helmìœ¼ë¡œ ì„¤ì¹˜
- name: Install Prometheus Stack using Helm
  ansible.builtin.command:
    cmd: >
      helm upgrade --install kube-prometheus-stack
      prometheus-community/kube-prometheus-stack
      --namespace monitoring
      --create-namespace
      --values {{ playbook_dir }}/../roles/monitoring/values.yml
      --timeout 15m
      --wait

  environment:
    KUBECONFIG: "{{ kubeconfig }}"
  register: prometheus_install
  changed_when: "'has been installed' in prometheus_install.stdout"

# 2. [ëŒ€ê¸°] ê·¸ë¼íŒŒë‚˜ ëœ° ë•Œê¹Œì§€ ê¸°ë‹¤ë¦¼
- name: Grafanaê°€ ëœ° ë•Œê¹Œì§€ ëŒ€ê¸° (í¬íŠ¸ 3000)
  wait_for:
    port: 3000
    delay: 10

# 3. [ì¡°íšŒ] ì¿ ë²„ë„¤í‹°ìŠ¤ ë¹„ë°€ìƒì(Secret)ì—ì„œ ëœë¤ ë¹„ë°€ë²ˆí˜¸ êº¼ë‚´ì˜¤ê¸° ğŸ•µï¸â€â™‚ï¸
- name: Get Grafana Random Password from K8s Secret
  ansible.builtin.shell: >
    kubectl get secret --namespace monitoring kube-prometheus-stack-grafana -o jsonpath="{.data.admin-password}" | base64 --decode
  environment:
    KUBECONFIG: "{{ kubeconfig }}"
  register: grafana_secret_output

# 4. [ì„¤ì •] êº¼ë‚´ì˜¨ ë¹„ë°€ë²ˆí˜¸ë¡œ ë¡œê·¸ì¸í•´ì„œ Loki ë“±ë¡í•˜ê¸° ğŸ¤–
- name: Loki ë°ì´í„°ì†ŒìŠ¤ ìë™ ë“±ë¡
  uri:
    url: "http://localhost:3000/api/datasources"
    method: POST
    user: admin
    password: "{{ grafana_secret_output.stdout }}"
    force_basic_auth: yes
    body_format: json
    body:
      name: Loki
      type: loki
      url: "http://loki.logging.svc.cluster.local:3100"
      access: proxy
      isDefault: true
    status_code: [200, 409]

# 5. [ì¶œë ¥] ì‚¬ìš©ìì—ê²Œ ë¹„ë°€ë²ˆí˜¸ ì•Œë ¤ì£¼ê¸° ğŸ“¢
- name: "ğŸ‰ ì„¤ì¹˜ ì™„ë£Œ! ì•„ë˜ ì •ë³´ë¡œ ë¡œê·¸ì¸í•˜ì„¸ìš”"
  ansible.builtin.debug:
    msg:
      - "---------------------------------------------------"
      - "ğŸš€ Grafana URL: http://localhost:3000"
      - "ğŸ‘¤ ID: admin"
      - "ğŸ”‘ PW: {{ grafana_secret_output.stdout }}"
      - "---------------------------------------------------"
      - "ìœ„ ë¹„ë°€ë²ˆí˜¸ë¥¼ ë³µì‚¬í•´ì„œ ë¡œê·¸ì¸í•˜ì„¸ìš”!"
