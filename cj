#!/bin/bash

# =============================================================================
# Cloud Janitor CLI Tool
# 
# Cloud JanitorëŠ” ê¸°ì¡´ì˜ target-clusterì— ì—°ê²°(attach)í•˜ì—¬
# target ë‚´ë¶€ì— Prometheusë¥¼ ì„¤ì¹˜í•˜ê³  ëª¨ë‹ˆí„°ë§í•˜ëŠ” ì‹œìŠ¤í…œ
#
# ì‚¬ìš©ë²•:
#   cj install           # cj CLI ì‹œìŠ¤í…œ PATHì— ë“±ë¡ (ì„¤ì¹˜)
#   cj init              # í”„ë¡œì íŠ¸ ì´ˆê¸°í™”
#   cj setup             # ì „ì²´ ì„¤ì • (target Prometheus ì„¤ì¹˜ + Mgmt Cluster ìƒì„±)
#   cj start             # ì„œë¹„ìŠ¤ ì‹œì‘
#   cj stop              # ì„œë¹„ìŠ¤ ì¤‘ì§€
#   cj tunnel <cmd>      # SSH í„°ë„ ê´€ë¦¬ (setup, stop, status)
#   cj tf <command>      # Terraform ëª…ë ¹ì–´ (init, apply, destroy, plan)
#   cj ans <playbook>    # Ansible playbook ì‹¤í–‰
#   cj status            # ìƒíƒœ í™•ì¸
#   cj logs <service>    # ë¡œê·¸ í™•ì¸
#   cj grafana           # Grafana ì ‘ì†
#   cj help              # ë„ì›€ë§
#
# ì•„í‚¤í…ì²˜:
#   - target-cluster: ì™¸ë¶€ ì„œë²„ì—ì„œ ì‹¤í–‰ë˜ëŠ” Docker Compose í™˜ê²½
#   - cj (Cloud Janitor): targetì— SSH í„°ë„ì„ í†µí•œ ì•ˆì „í•œ ì ‘ê·¼
#   - Management Cluster: cjì—ì„œ ìƒì„±í•˜ëŠ” Kind K8s (Grafana, Loki)
# =============================================================================

set -e  # ì—ëŸ¬ ë°œìƒ ì‹œ ì¦‰ì‹œ ì¢…ë£Œ

# ìƒ‰ìƒ ì •ì˜
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
MAGENTA='\033[0;35m'
BOLD='\033[1m'
NC='\033[0m' # No Color

# ë¡œê·¸ í•¨ìˆ˜
log_info() {
    echo -e "${BLUE}[INFO]${NC} $1"
}

log_success() {
    echo -e "${GREEN}[SUCCESS]${NC} $1"
}

log_warning() {
    echo -e "${YELLOW}[WARNING]${NC} $1"
}

log_error() {
    echo -e "${RED}[ERROR]${NC} $1"
}

log_step() {
    echo ""
    echo -e "${CYAN}==========================================${NC}"
    echo -e "${CYAN}$1${NC}"
    echo -e "${CYAN}==========================================${NC}"
}

# =============================================================================
# í”„ë¡œì íŠ¸ ê²½ë¡œ ì„¤ì •
# =============================================================================

# CJ_HOME í™˜ê²½ë³€ìˆ˜ê°€ ì„¤ì •ë˜ì–´ ìˆìœ¼ë©´ ì‚¬ìš©, ì•„ë‹ˆë©´ ìŠ¤í¬ë¦½íŠ¸ ìœ„ì¹˜ ì‚¬ìš©
CJ_HOME="${CJ_HOME:-$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)}"

# ê²½ë¡œ ì„¤ì •
TERRAFORM_DIR="$CJ_HOME/terraform"
ANSIBLE_DIR="$CJ_HOME/ansible"
SCRIPTS_DIR="$CJ_HOME/scripts"

# ìƒíƒœ íŒŒì¼
STATE_FILE="$CJ_HOME/.cj_state"

# Target ì£¼ì†Œ (í˜„ì¬ëŠ” localhost, ì‹¤ì œë¡œëŠ” ë‹¤ë¥¸ ì„œë²„)
TARGET_HOST="${TARGET_HOST:-localhost}"

# =============================================================================
# ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜
# =============================================================================

# í”„ë¡œì íŠ¸ ê²½ë¡œ í™•ì¸
check_cj_home() {
    if [ ! -d "$CJ_HOME" ]; then
        log_error "Cloud Janitor í”„ë¡œì íŠ¸ ë””ë ‰í† ë¦¬ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤: $CJ_HOME"
        log_info "CJ_HOME í™˜ê²½ë³€ìˆ˜ë¥¼ ì„¤ì •í•˜ê±°ë‚˜ cj ìŠ¤í¬ë¦½íŠ¸ê°€ ìˆëŠ” ë””ë ‰í† ë¦¬ì—ì„œ ì‹¤í–‰í•˜ì„¸ìš”."
        exit 1
    fi
}

# Docker ì„¤ì¹˜ í™•ì¸
check_docker() {
    if ! command -v docker &> /dev/null; then
        log_error "Dockerê°€ ì„¤ì¹˜ë˜ì–´ ìˆì§€ ì•ŠìŠµë‹ˆë‹¤."
        exit 1
    fi
}

# Terraform ì„¤ì¹˜ í™•ì¸
check_terraform() {
    if ! command -v terraform &> /dev/null; then
        log_error "Terraformê°€ ì„¤ì¹˜ë˜ì–´ ìˆì§€ ì•ŠìŠµë‹ˆë‹¤."
        exit 1
    fi
}

# Ansible ì„¤ì¹˜ í™•ì¸
check_ansible() {
    if ! command -v uv &> /dev/null; then
        log_error "uvê°€ ì„¤ì¹˜ë˜ì–´ ìˆì§€ ì•ŠìŠµë‹ˆë‹¤."
        exit 1
    fi
}

ensure_uv_sync() {
    if [ "${UV_SYNC_DONE:-false}" = "true" ]; then
        return 0
    fi
    log_info "uv sync ì‹¤í–‰ ì¤‘..."
    cd "$CJ_HOME"
    uv sync
    UV_SYNC_DONE=true
}

# kubectl ì„¤ì¹˜ í™•ì¸
check_kubectl() {
    if ! command -v kubectl &> /dev/null; then
        log_error "kubectlê°€ ì„¤ì¹˜ë˜ì–´ ìˆì§€ ì•ŠìŠµë‹ˆë‹¤."
        exit 1
    fi
}

# .env íŒŒì¼ í™•ì¸
check_env_file() {
    if [ ! -f "$CJ_HOME/.env" ]; then
        log_warning ".env íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤. .env.exampleì„ ë³µì‚¬í•©ë‹ˆë‹¤."
        cp "$CJ_HOME/.env.example" "$CJ_HOME/.env"
        log_warning ".env íŒŒì¼ì„ ì„¤ì •í•´ì£¼ì„¸ìš”. (íŠ¹íˆ GRAFANA_PASSWORD, TARGET_HOST)"
        return 1
    fi
    return 0
}

# SSH í„°ë„ ì„¤ì •
setup_ssh_tunnel() {
    check_env_file
    source "$CJ_HOME/.env"
    
    # SSH í„°ë„ ì„¤ì • í™•ì¸
    USE_SSH_TUNNEL="${USE_SSH_TUNNEL:-true}"
    TARGET_HOST="${TARGET_HOST:-localhost}"
    TARGET_SSH_USER="${TARGET_SSH_USER:-root}"
    TARGET_SSH_PORT="${TARGET_SSH_PORT:-22}"
    TARGET_SSH_KEY="${TARGET_SSH_KEY:-~/.ssh/id_rsa}"
    PROMETHEUS_PORT="${PROMETHEUS_PORT:-9091}"
    
    # ë¡œì»¬ì´ë©´ í„°ë„ í•„ìš” ì—†ìŒ
    if [ "$TARGET_HOST" = "localhost" ]; then
        log_info "Targetì´ ë¡œì»¬ì…ë‹ˆë‹¤. SSH í„°ë„ì„ ì„¤ì •í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤."
        return 0
    fi
    
    # SSH í„°ë„ ì‚¬ìš©í•˜ì§€ ì•Šìœ¼ë©´ ë¬´ì‹œ
    if [ "$USE_SSH_TUNNEL" != "true" ]; then
        log_info "SSH í„°ë„ ì‚¬ìš© ì•ˆ í•¨"
        return 0
    fi
    
    # ì´ë¯¸ SSH í„°ë„ì´ ì‹¤í–‰ ì¤‘ì¸ì§€ í™•ì¸
    SSH_TUNNEL_PID=$(pgrep -f "ssh.*${TARGET_HOST}.*${PROMETHEUS_PORT}" || true)
    if [ -n "$SSH_TUNNEL_PID" ]; then
        log_info "SSH í„°ë„ì´ ì´ë¯¸ ì‹¤í–‰ ì¤‘ì…ë‹ˆë‹¤ (PID: $SSH_TUNNEL_PID)"
        return 0
    fi
    
    # SSH í„°ë„ ìƒì„±
    log_info "SSH í„°ë„ ìƒì„± ì¤‘: ${TARGET_HOST}:${PROMETHEUS_PORT} -> localhost:${PROMETHEUS_PORT}"
    log_info "SSH ì‚¬ìš©ì: ${TARGET_SSH_USER}@${TARGET_HOST}:${TARGET_SSH_PORT}"
    log_info "SSH í‚¤: ${TARGET_SSH_KEY}"
    
    # SSH í‚¤ê°€ ìˆëŠ”ì§€ í™•ì¸
    if [ ! -f "$TARGET_SSH_KEY" ]; then
        log_warning "SSH í‚¤ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤: ${TARGET_SSH_KEY}"
        log_warning "SSH í‚¤ ì—†ì´ ë¹„ë°€ë²ˆí˜¸ë¡œ ì ‘ì†í•©ë‹ˆë‹¤ (ë¹„ì¶”ì²œ)"
    fi
    
    # SSH í„°ë„ ë°±ê·¸ë¼ìš´ë“œ ì‹¤í–‰
    ssh -i "$TARGET_SSH_KEY" \
        -L "localhost:${PROMETHEUS_PORT}:${TARGET_HOST}:${PROMETHEUS_PORT}" \
        -N \
        -p "${TARGET_SSH_PORT}" \
        "${TARGET_SSH_USER}@${TARGET_HOST}" \
        &>/dev/null &
    
    SSH_TUNNEL_PID=$!
    
    # SSH í„°ë„ ì‹œì‘ ëŒ€ê¸°
    sleep 2
    
    # SSH í„°ë„ í™•ì¸
    if ps -p "$SSH_TUNNEL_PID" > /dev/null 2>&1; then
        log_success "SSH í„°ë„ ìƒì„± ì„±ê³µ (PID: $SSH_TUNNEL_PID)"
        echo "$SSH_TUNNEL_PID" > "$CJ_HOME/.ssh_tunnel_pid"
    else
        log_error "SSH í„°ë„ ìƒì„± ì‹¤íŒ¨"
        return 1
    fi
}

# SSH í„°ë„ í•´ì œ
teardown_ssh_tunnel() {
    SSH_TUNNEL_PID_FILE="$CJ_HOME/.ssh_tunnel_pid"
    
    if [ ! -f "$SSH_TUNNEL_PID_FILE" ]; then
        log_info "SSH í„°ë„ PID íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."
        return 0
    fi
    
    SSH_TUNNEL_PID=$(cat "$SSH_TUNNEL_PID_FILE")
    
    if ps -p "$SSH_TUNNEL_PID" > /dev/null 2>&1; then
        log_info "SSH í„°ë„ ì¢…ë£Œ ì¤‘ (PID: $SSH_TUNNEL_PID)..."
        kill "$SSH_TUNNEL_PID"
        log_success "SSH í„°ë„ ì¢…ë£Œ ì™„ë£Œ"
    else
        log_info "SSH í„°ë„ì´ ì´ë¯¸ ì¢…ë£Œë˜ì—ˆìŠµë‹ˆë‹¤."
    fi
    
    rm -f "$SSH_TUNNEL_PID_FILE"
}

# SSH ì—°ê²° í™•ì¸
check_ssh_connection() {
    check_env_file
    source "$CJ_HOME/.env"
    
    TARGET_HOST="${TARGET_HOST:-localhost}"
    TARGET_SSH_USER="${TARGET_SSH_USER:-root}"
    TARGET_SSH_PORT="${TARGET_SSH_PORT:-22}"
    TARGET_SSH_KEY="${TARGET_SSH_KEY:-~/.ssh/id_rsa}"
    
    # ë¡œì»¬ì´ë©´ ë¬´ì‹œ
    if [ "$TARGET_HOST" = "localhost" ]; then
        return 0
    fi
    
    log_info "SSH ì—°ê²° í™•ì¸ ì¤‘: ${TARGET_SSH_USER}@${TARGET_HOST}:${TARGET_SSH_PORT}"
    
    if ssh -i "$TARGET_SSH_KEY" \
        -p "${TARGET_SSH_PORT}" \
        -o ConnectTimeout=5 \
        -o BatchMode=yes \
        "${TARGET_SSH_USER}@${TARGET_HOST}" \
        exit 2>/dev/null; then
        log_success "SSH ì—°ê²° ì„±ê³µ"
        return 0
    else
        log_error "SSH ì—°ê²° ì‹¤íŒ¨"
        log_info "  - SSH í‚¤ í™•ì¸: $TARGET_SSH_KEY"
        log_info "  - í˜¸ìŠ¤íŠ¸ í™•ì¸: $TARGET_HOST:$TARGET_SSH_PORT"
        log_info "  - ì‚¬ìš©ì í™•ì¸: $TARGET_SSH_USER"
        return 1
    fi
}

# State íŒŒì¼ ë¡œë“œ
load_state() {
    if [ -f "$STATE_FILE" ]; then
        source "$STATE_FILE"
    fi
}

# State íŒŒì¼ ì €ì¥
save_state() {
    cat > "$STATE_FILE" << EOF
CJ_HOME="$CJ_HOME"
TF_INITIALIZED="${TF_INITIALIZED:-false}"
MGMT_CLUSTER_CREATED="${MGMT_CLUSTER_CREATED:-false}"
TARGET_PROMETHEUS_INSTALLED="${TARGET_PROMETHEUS_INSTALLED:-false}"
CLOUD_JANITOR_DEPLOYED="${CLOUD_JANITOR_DEPLOYED:-false}"
EOF
}

# =============================================================================
# ë„ì›€ë§
# =============================================================================

show_help() {
    echo -e "${BOLD}Cloud Janitor CLI Tool${NC}"
    echo ""
    echo -e "ì‚¬ìš©ë²•: cj <command> [options]"
    echo ""
    echo -e "${BOLD}ì„¤ì¹˜:${NC}"
    echo "  install           cj CLI ì‹œìŠ¤í…œ PATHì— ë“±ë¡ (ì„¤ì¹˜)"
    echo ""
    echo -e "${BOLD}í”„ë¡œì íŠ¸ ê´€ë¦¬:${NC}"
    echo "  init              í”„ë¡œì íŠ¸ ì´ˆê¸°í™” (.env íŒŒì¼ ìƒì„±, ì˜ì¡´ì„± ì„¤ì¹˜ í™•ì¸)"
    echo "  setup             ì „ì²´ ì„¤ì • (Target Prometheus í™•ì¸ + Mgmt Cluster ìƒì„±)"
    echo "  start             ì„œë¹„ìŠ¤ ì‹œì‘"
    echo "  stop              ì„œë¹„ìŠ¤ ì¤‘ì§€"
    echo "  clear             ë¡œì»¬ ìƒíƒœ/íŒŒì¼ ì •ë¦¬"
    echo ""
    echo -e "${BOLD}Terraform (Management Cluster):${NC}"
    echo "  tf init           Terraform ì´ˆê¸°í™”"
    echo "  tf plan           Terraform ê³„íš í™•ì¸"
    echo "  tf apply          Terraform ì ìš© (í´ëŸ¬ìŠ¤í„° ìƒì„±)"
    echo "  tf destroy        Terraform ì‚­ì œ (í´ëŸ¬ìŠ¤í„° ì‚­ì œ)"
    echo "  tf clear          Terraform ë¡œì»¬ ìƒíƒœ ì •ë¦¬"
    echo "  tf output         Terraform ì¶œë ¥ê°’ í™•ì¸"
    echo "  tf shell          Terraform ì‰˜ ì‹¤í–‰ (terraform ëª…ë ¹ì–´ ì§ì ‘ ì‚¬ìš©)"
    echo ""
    echo -e "${BOLD}Ansible (Target Prometheus í™•ì¸):${NC}"
    echo "  ans install       Target Prometheus ì ‘ì† í™•ì¸"
    echo "  ans configure     Prometheus ì„¤ì • ë° Grafana ì—°ë™"
    echo "  ans shell         Ansible playbook ì‹¤í–‰ ì‰˜"
    echo ""
    echo -e "${BOLD}ìƒíƒœ ë° ë¡œê·¸:${NC}"
    echo "  status            ì „ì²´ ì‹œìŠ¤í…œ ìƒíƒœ í™•ì¸"
    echo "  logs [service]    ë¡œê·¸ í™•ì¸ (janitor, mysql, grafana, loki)"
    echo ""
    echo -e "${BOLD}ì ‘ì†:${NC}"
    echo "  grafana           Grafana ì ‘ì†"
    echo ""
    echo -e "${BOLD}ê¸°íƒ€:${NC}"
    echo "  env               .env íŒŒì¼ í¸ì§‘"
    echo "  kubeconfig        kubeconfig ê²½ë¡œ ì¶œë ¥"
    echo "  shell             Cloud Janitor í”„ë¡œì íŠ¸ ë””ë ‰í† ë¦¬ë¡œ ì´ë™"
    echo "  version           ë²„ì „ ì •ë³´"
    echo "  help              ì´ ë„ì›€ë§ í‘œì‹œ"
    echo ""
    echo -e "${BOLD}SSH í„°ë„ (ì™¸ë¶€ Target ì ‘ê·¼ìš©):${NC}"
    echo "  tunnel setup      SSH í„°ë„ ìƒì„± (localhost:9091 â†’ TARGET_HOST:9091)"
    echo "  tunnel stop       SSH í„°ë„ ì¢…ë£Œ"
    echo "  tunnel status     SSH í„°ë„ ìƒíƒœ í™•ì¸"
    echo ""
    echo -e "${BOLD}ì˜ˆì‹œ:${NC}"
    echo "  cj install                   # cj CLI ì„¤ì¹˜"
    echo "  cj init                      # í”„ë¡œì íŠ¸ ì´ˆê¸°í™”"
    echo "  cj setup                     # ì „ì²´ ì„¤ì •"
    echo "  cj status                    # ìƒíƒœ í™•ì¸"
    echo "  cj logs janitor              # Cloud Janitor ë¡œê·¸"
    echo "  cj stop                      # ì„œë¹„ìŠ¤ ì¤‘ì§€"
    echo ""
    echo -e "${BOLD}í™˜ê²½ ë³€ìˆ˜:${NC}"
    echo "  CJ_HOME         Cloud Janitor í”„ë¡œì íŠ¸ ê²½ë¡œ (ê¸°ë³¸ê°’: cj ìŠ¤í¬ë¦½íŠ¸ ìœ„ì¹˜)"
    echo "  TARGET_HOST     Target ì„œë²„ ì£¼ì†Œ (ê¸°ë³¸ê°’: localhost)"
    echo ""
}

show_version() {
    cat << EOF
Cloud Janitor CLI Tool v1.0.0
Zombie Pod Detection and Auto-Cleanup System

Project Path: $CJ_HOME
Target Host: $TARGET_HOST
EOF
}

# =============================================================================
# ì´ˆê¸°í™”
# =============================================================================

cmd_init() {
    log_step "ğŸš€ Cloud Janitor ì´ˆê¸°í™”"

    check_cj_home

    log_info "ê¸°ì¡´ í™˜ê²½ ì •ë¦¬ ì¤‘..."
    set +e
    if command -v terraform &> /dev/null; then
        if [ -d "$CJ_HOME/terraform" ]; then
            (cd "$CJ_HOME/terraform" && terraform init -input=false >/dev/null 2>&1)
            if (cd "$CJ_HOME/terraform" && terraform destroy -auto-approve); then
                log_success "ê¸°ì¡´ Terraform ë¦¬ì†ŒìŠ¤ ì‚­ì œ ì™„ë£Œ"
            else
                log_warning "Terraform ì‚­ì œê°€ ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ìƒíƒœë¥¼ ì •ë¦¬í•©ë‹ˆë‹¤."
                if (cd "$CJ_HOME/terraform" && terraform state list >/dev/null 2>&1); then
                    while read -r resource; do
                        (cd "$CJ_HOME/terraform" && terraform state rm "$resource" >/dev/null 2>&1) || true
                    done < <(cd "$CJ_HOME/terraform" && terraform state list 2>/dev/null)
                    log_success "Terraform ìƒíƒœ ì •ë¦¬ ì™„ë£Œ"
                fi
            fi
        fi
    fi

    rm -f "$CJ_HOME/terraform/cloud-janitor-cluster-config"
    rm -f "$CJ_HOME/terraform/terraform.tfstate"
    rm -f "$CJ_HOME/terraform/terraform.tfstate.backup"
    rm -f "$CJ_HOME/terraform/terraform.tfstate.lock.info"
    rm -rf "$CJ_HOME/terraform/.terraform"
    rm -f "$STATE_FILE"
    rm -f "$CJ_HOME/.ssh_tunnel_pid"

    if command -v kind &> /dev/null; then
        if kind get clusters 2>/dev/null | grep -q "^cloud-janitor-cluster$"; then
            KUBECONFIG="$CJ_HOME/terraform/cloud-janitor-cluster-config" kind delete cluster --name cloud-janitor-cluster
            log_success "ê¸°ì¡´ kind í´ëŸ¬ìŠ¤í„° ì‚­ì œ ì™„ë£Œ"
        fi
    fi
    set -e

    # ë””ë ‰í† ë¦¬ êµ¬ì¡° í™•ì¸
    log_info "í”„ë¡œì íŠ¸ ë””ë ‰í† ë¦¬ êµ¬ì¡° í™•ì¸ ì¤‘..."
    
    for dir in terraform ansible; do
        if [ -d "$CJ_HOME/$dir" ]; then
            log_success "$dir/ âœ“"
        else
            log_error "$dir/ âœ— (ë””ë ‰í† ë¦¬ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ)"
            exit 1
        fi
    done

    # í•„ìˆ˜ íŒŒì¼ í™•ì¸
    log_info "í•„ìˆ˜ íŒŒì¼ í™•ì¸ ì¤‘..."
    
    if [ -f "$CJ_HOME/.env.example" ]; then
        log_success ".env.example âœ“"
    else
        log_error ".env.example âœ—"
        exit 1
    fi

    # .env íŒŒì¼ ìƒì„±
    if [ ! -f "$CJ_HOME/.env" ]; then
        log_info ".env íŒŒì¼ ìƒì„± ì¤‘..."
        cp "$CJ_HOME/.env.example" "$CJ_HOME/.env"
        log_success ".env íŒŒì¼ ìƒì„± ì™„ë£Œ"
        log_warning ".env íŒŒì¼ì„ ì„¤ì •í•´ì£¼ì„¸ìš” (vim $CJ_HOME/.env)"
        log_warning "íŠ¹íˆ TARGET_HOSTë¥¼ ì„¤ì •í•˜ì„¸ìš” (ê¸°ë³¸ê°’: localhost)"
    else
        log_info ".env íŒŒì¼ì´ ì´ë¯¸ ì¡´ì¬í•©ë‹ˆë‹¤."
    fi

    # ì˜ì¡´ì„± í™•ì¸
    log_info "í•„ìˆ˜ ë„êµ¬ í™•ì¸ ì¤‘..."

    if command -v docker &> /dev/null; then
        log_success "Docker âœ“"
    else
        log_warning "Docker âœ— (ì„¤ì¹˜ í•„ìš” - TC ì‹¤í–‰ìš©)"
    fi

    if command -v terraform &> /dev/null; then
        log_success "Terraform âœ“"
    else
        log_warning "Terraform âœ— (ì„¤ì¹˜ í•„ìš”)"
    fi

    if command -v uv &> /dev/null; then
        log_success "uv âœ“"
    else
        log_warning "uv âœ— (ì„¤ì¹˜ í•„ìš”)"
    fi

    if command -v kubectl &> /dev/null; then
        log_success "kubectl âœ“"
    else
        log_warning "kubectl âœ— (ì„¤ì¹˜ í•„ìš”)"
    fi

    # State íŒŒì¼ ì´ˆê¸°í™”
    save_state

    log_step "âœ… ì´ˆê¸°í™” ì™„ë£Œ"
    echo ""
    log_info "ë‹¤ìŒ ëª…ë ¹ì–´ë¡œ ê³„ì† ì§„í–‰í•˜ì„¸ìš”:"
    echo "   tc start              # Target ì•±(ì¢€ë¹„ í¬í•¨) ì‹œì‘"
    echo "   tc pm start           # Target Prometheus ì‹œì‘"
    echo "   cj setup              # Management ì„¤ì •"
    echo ""
    log_info "ì°¸ê³ : Target PrometheusëŠ” tcì—ì„œ ë³„ë„ ì‹¤í–‰í•©ë‹ˆë‹¤."
    echo ""
    log_info "ë‹¤ìŒ ëª…ë ¹ì–´ ì¶”ì²œ:"
    echo "   tc start"
    echo ""
}

# =============================================================================
# cj CLI ì„¤ì¹˜
# =============================================================================

cmd_install() {
    log_step "ğŸ“¦ cj CLI ì„¤ì¹˜"

    # cj ìŠ¤í¬ë¦½íŠ¸ í™•ì¸
    CJ_CLI="$CJ_HOME/cj"

    if [ ! -f "$CJ_CLI" ]; then
        log_error "cj CLI ìŠ¤í¬ë¦½íŠ¸ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤: $CJ_CLI"
        exit 1
    fi

    # ì‹¤í–‰ ê¶Œí•œ í™•ì¸
    if [ ! -x "$CJ_CLI" ]; then
        log_info "cj ìŠ¤í¬ë¦½íŠ¸ì— ì‹¤í–‰ ê¶Œí•œ ë¶€ì—¬ ì¤‘..."
        chmod +x "$CJ_CLI"
        log_success "ì‹¤í–‰ ê¶Œí•œ ë¶€ì—¬ ì™„ë£Œ"
    fi

    echo ""
    echo "=========================================="
    echo "  Cloud Janitor CLI ë„êµ¬ ì„¤ì¹˜"
    echo "=========================================="
    echo ""

    # ì‰˜ íƒ€ì… ìë™ ê°ì§€
    SHELL_TYPE=""
    RC_FILE=""

    if [ -n "$ZSH_VERSION" ]; then
        SHELL_TYPE="zsh"
        RC_FILE="$HOME/.zshrc"
        log_info "ê°ì§€ëœ ì‰˜: zsh"
    elif [ -n "$BASH_VERSION" ]; then
        SHELL_TYPE="bash"
        RC_FILE="$HOME/.bashrc"
        log_info "ê°ì§€ëœ ì‰˜: bash"
    else
        SHELL_TYPE="bash"
        RC_FILE="$HOME/.bashrc"
        log_warning "ì‰˜ íƒ€ì…ì„ ê°ì§€í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. bashë¥¼ ê¸°ë³¸ìœ¼ë¡œ ì‚¬ìš©í•©ë‹ˆë‹¤."
    fi

    echo ""

    # 1) ì‹œìŠ¤í…œ PATHì— ì‹¬ë³¼ë¦­ ë§í¬ ìƒì„± ì‹œë„
    log_info "ì‹œìŠ¤í…œ PATHì— ì‹¬ë³¼ë¦­ ë§í¬ ìƒì„± ì¤‘..."

    LINK_LOCATIONS=(
        "/usr/local/bin/cj"
        "$HOME/.local/bin/cj"
    )

    LINK_SUCCESS=false

    for link_path in "${LINK_LOCATIONS[@]}"; do
        link_dir=$(dirname "$link_path")

        if [ ! -d "$link_dir" ]; then
            continue
        fi

        if [ ! -w "$link_dir" ]; then
            continue
        fi

        if [ -e "$link_path" ]; then
            rm -f "$link_path"
        fi

        ln -s "$CJ_CLI" "$link_path"
        log_success "ì‹¬ë³¼ë¦­ ë§í¬ ìƒì„±: $link_path â†’ $CJ_CLI"
        LINK_SUCCESS=true
        break
    done

    if [ "$LINK_SUCCESS" = false ]; then
        log_warning "ì‹œìŠ¤í…œ PATHì— ì‹¬ë³¼ë¦­ ë§í¬ë¥¼ ìƒì„±í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤."
    fi

    echo ""

    # 2) RC íŒŒì¼ì— PATH ì¶”ê°€
    log_info "$RC_FILEì— CJ_HOMEê³¼ PATH ì¶”ê°€ ì¤‘..."

    if [ ! -f "$RC_FILE" ]; then
        log_warning "$RC_FILE íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤. ìƒì„±í•©ë‹ˆë‹¤."
        touch "$RC_FILE"
    fi

    # Cloud Janitor CLI ì¶”ê°€ (ì´ë¯¸ ìˆìœ¼ë©´ ë¬´ì‹œ)
    if ! grep -q "Cloud Janitor CLI" "$RC_FILE" 2>/dev/null; then
        cat >> "$RC_FILE" << EOF

# Cloud Janitor CLI
export CJ_HOME="$CJ_HOME"
export PATH="\$PATH:\$CJ_HOME"
EOF
        log_success "$RC_FILEì— ì¶”ê°€ ì™„ë£Œ"
    else
        log_info "$RC_FILEì— ì´ë¯¸ Cloud Janitor CLI ì„¤ì •ì´ ìˆìŠµë‹ˆë‹¤. (ë®ì–´ì“°ì§€ ì•ŠìŒ)"
    fi

    # ì„¤ì¹˜ ì™„ë£Œ ë©”ì‹œì§€
    echo "=========================================="
    echo "  ì„¤ì¹˜ ì™„ë£Œ"
    echo "=========================================="
    echo ""
    log_success "ì´ì œ ë‹¤ìŒ ëª…ë ¹ì–´ë¥¼ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤:"
    echo ""
    echo "  cj help              # ë„ì›€ë§"
    echo "  cj init             # í”„ë¡œì íŠ¸ ì´ˆê¸°í™”"
    echo "  cj setup            # ì „ì²´ ì„¤ì •"
    echo "  cj status           # ìƒíƒœ í™•ì¸"
    echo ""
    log_info "ë‹¤ìŒ ëª…ë ¹ì–´ ì¶”ì²œ:"
    echo "  cj init"
    echo ""
}

# =============================================================================
# ì „ì²´ ì„¤ì •
# =============================================================================

cmd_setup() {
    log_step "ğŸš€ Cloud Janitor ì „ì²´ ì„¤ì •"

    check_cj_home
    check_env_file || exit 1

    # .env íŒŒì¼ ë¡œë“œ
    source "$CJ_HOME/.env"

    # TARGET_HOST ì„¤ì • í™•ì¸
    if [ -z "$TARGET_HOST" ]; then
        TARGET_HOST="localhost"
        log_warning "TARGET_HOSTê°€ ì„¤ì •ë˜ì§€ ì•Šì•„ ê¸°ë³¸ê°’(localhost)ì„ ì‚¬ìš©í•©ë‹ˆë‹¤."
        log_info ".env íŒŒì¼ì—ì„œ TARGET_HOSTë¥¼ ì„¤ì •í•˜ì„¸ìš”."
    fi

    log_info "Target Host: $TARGET_HOST"
    echo ""

    # SSH í„°ë„ ì„¤ì • (ì™¸ë¶€ Targetì¼ ê²½ìš°)
    if [ "$TARGET_HOST" != "localhost" ]; then
        log_info "ì™¸ë¶€ Target Cluster ê°ì§€ë¨. SSH í„°ë„ì„ ì„¤ì •í•©ë‹ˆë‹¤."
        
        # SSH ì—°ê²° í™•ì¸
        if ! check_ssh_connection; then
            log_error "SSH ì—°ê²° ì‹¤íŒ¨. ì„¤ì •ì„ í™•ì¸í•˜ì„¸ìš”."
            exit 1
        fi
        
        # SSH í„°ë„ ì„¤ì •
        setup_ssh_tunnel || exit 1
    fi

    # ìŠ¤í¬ë¦½íŠ¸ ì¢…ë£Œ ì‹œ SSH í„°ë„ í•´ì œ
    trap teardown_ssh_tunnel EXIT

    # 1. Target Prometheus í™•ì¸
    log_info "STEP 1/4: Target Prometheus í™•ì¸"
    cmd_ans install

    # 2. Terraform ì´ˆê¸°í™”
    if [ "$TF_INITIALIZED" != "true" ]; then
        log_info "STEP 2/4: Terraform ì´ˆê¸°í™”"
        cmd_tf init
    else
        log_info "STEP 2/4: Terraform ì´ë¯¸ ì´ˆê¸°í™”ë¨"
    fi

    # 3. Management Cluster ìƒì„±
    if [ "$MGMT_CLUSTER_CREATED" != "true" ]; then
        log_info "STEP 3/4: Management Cluster ìƒì„±"
        cmd_tf apply -auto-approve
    else
        log_info "STEP 3/4: Management Cluster ì´ë¯¸ ìƒì„±ë¨"
    fi

    # 4. Prometheus ì„¤ì • ë° Grafana ì—°ë™
    log_info "STEP 4/4: Prometheus ì„¤ì • ë° Grafana ì—°ë™"
    cmd_ans configure
    if [ "$TARGET_PROMETHEUS_INSTALLED" != "true" ]; then
        log_warning "Target Prometheusê°€ ì•„ì§ ì‹¤í–‰ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤."
        log_info "ë‹¤ìŒ ìˆœì„œë¡œ ì§„í–‰í•˜ì„¸ìš”:"
        echo "   tc pm start"
        echo "   cj ans configure"
    fi

    # SSH í„°ë„ ìœ ì§€ ì•ˆë‚´
    if [ "$TARGET_HOST" != "localhost" ]; then
        log_step "ğŸ” SSH í„°ë„ ìœ ì§€"
        log_warning "SSH í„°ë„ì´ ë°±ê·¸ë¼ìš´ë“œì—ì„œ ì‹¤í–‰ ì¤‘ì…ë‹ˆë‹¤."
        log_warning "ì¢…ë£Œí•˜ë ¤ë©´: Ctrl+C ë˜ëŠ” cj tunnel stop"
        log_info "SSH í„°ë„ í™•ì¸: cj tunnel status"
    fi

    log_step "ğŸ‰ ì „ì²´ ì„¤ì • ì™„ë£Œ"
    echo ""
    log_info "ì ‘ì† ì •ë³´:"
    echo "   ğŸ“Š Target Prometheus:  http://$TARGET_HOST:9091"
    echo "   ğŸ“ˆ Grafana (Mgmt):     http://localhost:3000"
    echo ""
    log_info "ìƒíƒœ í™•ì¸:"
    echo "   cj status"
    echo ""
    log_info "ë‹¤ìŒ ëª…ë ¹ì–´ ì¶”ì²œ:"
    echo "   cj start"
}

# =============================================================================
# ì„œë¹„ìŠ¤ ì‹œì‘
# =============================================================================

cmd_start() {
    log_step "ğŸš€ ì„œë¹„ìŠ¤ ì‹œì‘"

    check_cj_home
    load_state

    log_info "Cloud Janitor ì„œë¹„ìŠ¤ë¥¼ ì‹œì‘í•©ë‹ˆë‹¤..."

    # Management Clusterê°€ ìƒì„±ë˜ì–´ ìˆëŠ”ì§€ í™•ì¸
    if [ "$MGMT_CLUSTER_CREATED" != "true" ]; then
        log_warning "Management Clusterê°€ ìƒì„±ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤."
        log_info "ë¨¼ì € ë‹¤ìŒì„ ì‹¤í–‰í•˜ì„¸ìš”: cj setup"
        exit 1
    fi

    # kubeconfig ì„¤ì •
    export KUBECONFIG="$CJ_HOME/terraform/cloud-janitor-cluster-config"

    # Cloud Janitor Podê°€ ì‹¤í–‰ ì¤‘ì¸ì§€ í™•ì¸
    if kubectl get deployment cloud-janitor -n default &> /dev/null; then
        log_info "Cloud Janitor Deploymentê°€ ì´ë¯¸ ì¡´ì¬í•©ë‹ˆë‹¤."
        log_info "Deploymentë¥¼ ì¬ì‹œì‘í•©ë‹ˆë‹¤..."
        kubectl rollout restart deployment/cloud-janitor -n default
    else
        log_warning "Cloud Janitor Deploymentë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."
        log_info "Ansibleë¡œ Cloud Janitorë¥¼ ë°°í¬í•©ë‹ˆë‹¤..."
        cd "$CJ_HOME"
        export ANSIBLE_CONFIG="$ANSIBLE_DIR/ansible.cfg"
        export ANSIBLE_ROLES_PATH="$ANSIBLE_DIR/roles"
        export ANSIBLE_LOCAL_TMP="${ANSIBLE_LOCAL_TMP:-/tmp/ansible}"
        export ANSIBLE_REMOTE_TMP="${ANSIBLE_REMOTE_TMP:-/tmp/ansible}"
        mkdir -p "$ANSIBLE_LOCAL_TMP"
        ensure_uv_sync
        uv run ansible-playbook "$ANSIBLE_DIR/playbooks/setup-cluster.yml"
    fi

    # ìƒíƒœ í™•ì¸
    log_info "Pod ìƒíƒœ í™•ì¸ ì¤‘..."
    kubectl get pods -n default -l app=cloud-janitor

    log_success "ì„œë¹„ìŠ¤ ì‹œì‘ ì™„ë£Œ"
    log_info "ë¡œê·¸ í™•ì¸: cj logs janitor"
    echo ""
    log_info "ë‹¤ìŒ ëª…ë ¹ì–´ ì¶”ì²œ:"
    echo "   cj status"
}

# =============================================================================
# ì„œë¹„ìŠ¤ ì¤‘ì§€
# =============================================================================

cmd_stop() {
    log_step "ğŸ›‘ ì„œë¹„ìŠ¤ ì¤‘ì§€"

    check_cj_home
    check_kubectl

    # kubeconfig ì„¤ì •
    export KUBECONFIG="$CJ_HOME/terraform/cloud-janitor-cluster-config"

    log_info "Cloud Janitor ì„œë¹„ìŠ¤ë¥¼ ì¤‘ì§€í•©ë‹ˆë‹¤..."

    # Cloud Janitor Deployment ìŠ¤ì¼€ì¼ë§
    if kubectl get deployment cloud-janitor -n default &> /dev/null; then
        log_info "Cloud Janitor Deploymentë¥¼ ì¤‘ì§€í•©ë‹ˆë‹¤..."
        kubectl scale deployment/cloud-janitor -n default --replicas=0
        log_success "Cloud Janitor ì¤‘ì§€ ì™„ë£Œ"
    else
        log_warning "Cloud Janitor Deploymentë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."
    fi

    log_info "ì„œë¹„ìŠ¤ê°€ ì¤‘ì§€ë˜ì—ˆìŠµë‹ˆë‹¤."
    log_info "ë‹¤ì‹œ ì‹œì‘í•˜ë ¤ë©´: cj start"
    echo ""
    log_info "ë‹¤ìŒ ëª…ë ¹ì–´ ì¶”ì²œ:"
    echo "   cj start"
}

cmd_clear() {
    log_step "ğŸ§¹ ë¡œì»¬ ì •ë¦¬"

    check_cj_home

    rm -f "$CJ_HOME/.ssh_tunnel_pid"
    rm -f "$CJ_HOME/terraform/cloud-janitor-cluster-config"
    rm -f "$CJ_HOME/terraform/terraform.tfstate"
    rm -f "$CJ_HOME/terraform/terraform.tfstate.backup"
    rm -f "$CJ_HOME/terraform/terraform.tfstate.lock.info"
    rm -f "$CJ_HOME/terraform/.terraform.lock.hcl"
    rm -rf "$CJ_HOME/terraform/.terraform"

    TF_INITIALIZED=false
    MGMT_CLUSTER_CREATED=false
    TARGET_PROMETHEUS_INSTALLED=false
    CLOUD_JANITOR_DEPLOYED=false
    save_state

    if command -v kind &> /dev/null; then
        if kind get clusters 2>/dev/null | grep -q "^cloud-janitor-cluster$"; then
            log_warning "kind í´ëŸ¬ìŠ¤í„°ëŠ” ë‚¨ì•„ìˆìŠµë‹ˆë‹¤. í•„ìš”í•˜ë©´ cj tf destroyë¥¼ ì‹¤í–‰í•˜ì„¸ìš”."
        fi
    fi

    log_success "ë¡œì»¬ ìƒíƒœ ì •ë¦¬ ì™„ë£Œ"
    echo ""
    log_info "ë‹¤ìŒ ëª…ë ¹ì–´ ì¶”ì²œ:"
    echo "   cj tf init"
}

# =============================================================================
# Terraform ëª…ë ¹ì–´
# =============================================================================

cmd_tf() {
    local subcmd=$1
    shift || true

    check_terraform
    check_cj_home

    cd "$TERRAFORM_DIR"

    case $subcmd in
        init)
            log_step "ğŸ—ï¸  Terraform ì´ˆê¸°í™”"
            terraform init
            TF_INITIALIZED=true
            save_state
            echo ""
            log_info "ë‹¤ìŒ ëª…ë ¹ì–´ ì¶”ì²œ:"
            echo "   cj tf apply"
            ;;
        plan)
            log_step "ğŸ“‹ Terraform ê³„íš í™•ì¸"
            terraform plan
            ;;
        apply)
            log_step "ğŸš€ Terraform ì ìš©"
            log_info "Management Clusterë¥¼ ìƒì„±í•©ë‹ˆë‹¤..."
            local apply_args=("$@")
            local auto_approve=false
            for arg in "${apply_args[@]}"; do
                if [ "$arg" = "-auto-approve" ]; then
                    auto_approve=true
                fi
            done

            local bootstrap_args=()
            if [ "$auto_approve" = true ]; then
                bootstrap_args+=("-auto-approve")
            fi

            local need_bootstrap=true
            local has_kind_state=false
            local kind_exists=false
            if terraform state list 2>/dev/null | grep -q "^kind_cluster.default$"; then
                has_kind_state=true
            fi
            if command -v kind &> /dev/null; then
                if kind get clusters 2>/dev/null | grep -q "^cloud-janitor-cluster$"; then
                    kind_exists=true
                fi
            fi
            if [ "$has_kind_state" = false ] && [ "$kind_exists" = true ]; then
                log_warning "Terraform ìƒíƒœì— ì—†ëŠ” kind í´ëŸ¬ìŠ¤í„°ê°€ ì¡´ì¬í•©ë‹ˆë‹¤. ì‚­ì œí•©ë‹ˆë‹¤..."
                kind delete cluster --name cloud-janitor-cluster
                kind_exists=false
            fi
            if [ "$has_kind_state" = false ]; then
                need_bootstrap=true
            fi
            if [ "$kind_exists" = true ] && [ "$has_kind_state" = true ]; then
                need_bootstrap=false
            fi

            if [ "$need_bootstrap" = true ]; then
                log_info "kind í´ëŸ¬ìŠ¤í„°ë¥¼ ë¨¼ì € ìƒì„±í•©ë‹ˆë‹¤..."
                if terraform state list 2>/dev/null | grep -q "^kubernetes_"; then
                    log_warning "ê¸°ì¡´ Kubernetes ë¦¬ì†ŒìŠ¤ ìƒíƒœë¥¼ ì •ë¦¬í•©ë‹ˆë‹¤..."
                    while read -r resource; do
                        terraform state rm "$resource" >/dev/null 2>&1 || true
                    done < <(terraform state list 2>/dev/null | grep "^kubernetes_")
                    log_success "Kubernetes ìƒíƒœ ì •ë¦¬ ì™„ë£Œ"
                fi
                terraform apply -target kind_cluster.default "${bootstrap_args[@]}"
            fi

            terraform apply "${apply_args[@]}"
            MGMT_CLUSTER_CREATED=true
            save_state
            log_success "Management Cluster ìƒì„± ì™„ë£Œ"
            log_info "kubeconfig: $CJ_HOME/terraform/cloud-janitor-cluster-config"
            echo ""
            log_info "ë‹¤ìŒ ëª…ë ¹ì–´ ì¶”ì²œ:"
            echo "   cj ans configure"
            ;;
        destroy)
            log_step "ğŸ—‘ï¸  Terraform ì‚­ì œ"
            log_warning "Management Clusterë¥¼ ì‚­ì œí•©ë‹ˆë‹¤..."
            terraform init -input=false
            terraform destroy "$@"
            rm -f "$CJ_HOME/terraform/cloud-janitor-cluster-config"
            MGMT_CLUSTER_CREATED=false
            CLOUD_JANITOR_DEPLOYED=false
            save_state
            log_success "Management Cluster ì‚­ì œ ì™„ë£Œ"
            echo ""
            log_info "ë‹¤ìŒ ëª…ë ¹ì–´ ì¶”ì²œ:"
            echo "   cj init"
            ;;
        clear)
            log_step "ğŸ§¹ Terraform ë¡œì»¬ ìƒíƒœ ì •ë¦¬"
            rm -f "$CJ_HOME/terraform/cloud-janitor-cluster-config"
            rm -f "$CJ_HOME/terraform/terraform.tfstate"
            rm -f "$CJ_HOME/terraform/terraform.tfstate.backup"
            rm -f "$CJ_HOME/terraform/terraform.tfstate.lock.info"
            rm -f "$CJ_HOME/terraform/.terraform.lock.hcl"
            rm -rf "$CJ_HOME/terraform/.terraform"
            TF_INITIALIZED=false
            MGMT_CLUSTER_CREATED=false
            CLOUD_JANITOR_DEPLOYED=false
            save_state
            if command -v kind &> /dev/null; then
                if kind get clusters 2>/dev/null | grep -q "^cloud-janitor-cluster$"; then
                    log_warning "kind í´ëŸ¬ìŠ¤í„°ëŠ” ë‚¨ì•„ìˆìŠµë‹ˆë‹¤. í•„ìš”í•˜ë©´ cj tf destroyë¥¼ ì‹¤í–‰í•˜ì„¸ìš”."
                fi
            fi
            log_success "Terraform ë¡œì»¬ ìƒíƒœ ì •ë¦¬ ì™„ë£Œ"
            echo ""
            log_info "ë‹¤ìŒ ëª…ë ¹ì–´ ì¶”ì²œ:"
            echo "   cj tf init"
            ;;
        output)
            terraform output "$@"
            ;;
        shell)
            log_info "Terraform ì‰˜ ì‹œì‘ (exitë¡œ ì¢…ë£Œ)"
            bash
            ;;
        *)
            log_error "ì•Œ ìˆ˜ ì—†ëŠ” Terraform ëª…ë ¹ì–´: $subcmd"
            echo ""
            echo "ì‚¬ìš© ê°€ëŠ¥í•œ ëª…ë ¹ì–´:"
            echo "  cj tf init           Terraform ì´ˆê¸°í™”"
            echo "  cj tf plan           Terraform ê³„íš í™•ì¸"
            echo "  cj tf apply          Terraform ì ìš©"
            echo "  cj tf destroy        Terraform ì‚­ì œ"
            echo "  cj tf clear          Terraform ë¡œì»¬ ìƒíƒœ ì •ë¦¬"
            echo "  cj tf output         Terraform ì¶œë ¥ê°’ í™•ì¸"
            echo "  cj tf shell          Terraform ì‰˜"
            exit 1
            ;;
    esac
}

# =============================================================================
# Ansible ëª…ë ¹ì–´
# =============================================================================

cmd_ans() {
    local subcmd=$1
    shift || true

    check_ansible
    check_docker
    check_cj_home
    ensure_uv_sync

    export DOCKER_CONFIG="$CJ_HOME/.docker"

    # .env íŒŒì¼ ë¡œë“œ
    source "$CJ_HOME/.env"

    # TARGET_HOST ì„¤ì •
    TARGET_HOST="${TARGET_HOST:-localhost}"

    export ANSIBLE_CONFIG="$ANSIBLE_DIR/ansible.cfg"
    export ANSIBLE_ROLES_PATH="$ANSIBLE_DIR/roles"
    export ANSIBLE_LOCAL_TMP="${ANSIBLE_LOCAL_TMP:-/tmp/ansible}"
    export ANSIBLE_REMOTE_TMP="${ANSIBLE_REMOTE_TMP:-/tmp/ansible}"
    mkdir -p "$ANSIBLE_LOCAL_TMP"

    cd "$CJ_HOME"

    case $subcmd in
        install)
            log_step "ğŸ“¦ Target Prometheus í™•ì¸"
            log_info "Target ì„œë²„: $TARGET_HOST"
            PROMETHEUS_URL="http://$TARGET_HOST:9091"

            if curl -s -o /dev/null -w "%{http_code}" "$PROMETHEUS_URL/-/healthy" | grep -q "200"; then
                TARGET_PROMETHEUS_INSTALLED=true
                save_state
                log_success "Target Prometheus ì ‘ì† ì„±ê³µ"
            else
                TARGET_PROMETHEUS_INSTALLED=false
                save_state
                log_warning "Target Prometheus ì ‘ì† ì‹¤íŒ¨"
                log_info "ë¨¼ì € ì‹¤í–‰í•˜ì„¸ìš”: tc pm start"
            fi
            echo ""
            log_info "ë‹¤ìŒ ëª…ë ¹ì–´ ì¶”ì²œ:"
            if [ "$TARGET_PROMETHEUS_INSTALLED" = "true" ]; then
                echo "   cj ans configure"
            else
                echo "   tc pm start"
            fi
            ;;
            
        configure)
            log_step "ğŸ”§ Prometheus ì„¤ì • ë° Grafana ì—°ë™"
            
            # kubeconfig ì„¤ì •
            export KUBECONFIG="$CJ_HOME/terraform/cloud-janitor-cluster-config"
            
            # Prometheus URL í™•ì¸
            PROMETHEUS_URL="http://$TARGET_HOST:9091"
            
            log_info "Prometheus URL: $PROMETHEUS_URL"
            
            # Prometheus ì ‘ì† í™•ì¸
            if curl -s -o /dev/null -w "%{http_code}" "$PROMETHEUS_URL/-/healthy" | grep -q "200"; then
                log_success "Target Prometheus ì ‘ì† ì„±ê³µ"
            else
                log_warning "Target Prometheus ì ‘ì† ì‹¤íŒ¨"
                log_info "ë¨¼ì € ì‹¤í–‰í•˜ì„¸ìš”: tc pm start"
                echo ""
                log_info "ë‹¤ìŒ ëª…ë ¹ì–´ ì¶”ì²œ:"
                echo "   tc pm start"
                return 0
            fi
            
            # Grafanaì— Target Prometheus ë°ì´í„°ì†ŒìŠ¤ ì¶”ê°€
            log_info "Grafanaì— Target Prometheus ë°ì´í„°ì†ŒìŠ¤ ì¶”ê°€ ì¤‘..."
            
            if [ -f "$CJ_HOME/ansible/playbooks/setup-target.yml" ]; then
                uv run ansible-playbook "$ANSIBLE_DIR/playbooks/setup-target.yml" \
                    -e "target_prometheus_url=$PROMETHEUS_URL"
                
                log_success "Prometheus ì„¤ì • ë° Grafana ì—°ë™ ì™„ë£Œ"
            else
                log_warning "setup-target.ymlë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."
                log_info "ìˆ˜ë™ìœ¼ë¡œ Grafanaì—ì„œ Target Prometheusë¥¼ ë°ì´í„°ì†ŒìŠ¤ë¡œ ì¶”ê°€í•˜ì„¸ìš”."
                log_info "  URL: $PROMETHEUS_URL"
            fi
            echo ""
            log_info "ë‹¤ìŒ ëª…ë ¹ì–´ ì¶”ì²œ:"
            echo "   cj start"
            ;;
            
        shell)
            log_info "Ansible ì‰˜ ì‹œì‘ (exitë¡œ ì¢…ë£Œ)"
            bash
            ;;
            
        *)
            log_error "ì•Œ ìˆ˜ ì—†ëŠ” Ansible ëª…ë ¹ì–´: $subcmd"
            echo ""
            echo "ì‚¬ìš© ê°€ëŠ¥í•œ ëª…ë ¹ì–´:"
            echo "  cj ans install       Target Prometheus ì ‘ì† í™•ì¸"
            echo "  cj ans configure     Prometheus ì„¤ì • ë° Grafana ì—°ë™"
            echo "  cj ans shell          Ansible ì‰˜"
            exit 1
            ;;
    esac
}

# =============================================================================
# ìƒíƒœ í™•ì¸
# =============================================================================

cmd_status() {
    log_step "ğŸ“Š Cloud Janitor ìƒíƒœ"

    check_cj_home
    load_state

    # .env íŒŒì¼ ë¡œë“œ
    if [ -f "$CJ_HOME/.env" ]; then
        source "$CJ_HOME/.env"
    fi
    TARGET_HOST="${TARGET_HOST:-localhost}"

    echo ""
    echo "ğŸ¯ Target Cluster (ì™¸ë¶€ ì„œë²„):"
    echo "   Host: $TARGET_HOST"
    
    # Target Prometheus í™•ì¸
    PROMETHEUS_URL="http://$TARGET_HOST:9091"
    if curl -s -o /dev/null -w "%{http_code}" "$PROMETHEUS_URL/-/healthy" 2>/dev/null | grep -q "200"; then
        echo -e "   Prometheus: ${GREEN}ì‹¤í–‰ ì¤‘${NC} ($PROMETHEUS_URL)"
    else
        echo -e "   Prometheus: ${RED}ì¤‘ì§€${NC} ($PROMETHEUS_URL)"
    fi

    echo ""
    echo "ğŸ›ï¸  Management Cluster:"
    if [ "$MGMT_CLUSTER_CREATED" = "true" ]; then
        echo -e "   ìƒíƒœ: ${GREEN}ìƒì„±ë¨${NC}"
        
        # kubeconfig í™•ì¸
        if [ -f "$CJ_HOME/terraform/cloud-janitor-cluster-config" ]; then
            export KUBECONFIG="$CJ_HOME/terraform/cloud-janitor-cluster-config"
            echo "   K8s Pods:"
            kubectl get pods -A --no-headers | head -5 | while read ns rest; do
                echo "     - $rest"
            done
        fi
    else
        echo -e "   ìƒíƒœ: ${YELLOW}ìƒì„± ì•ˆë¨${NC}"
    fi

    echo ""
    echo "ğŸ Cloud Janitor:"
    if [ "$CLOUD_JANITOR_DEPLOYED" = "true" ]; then
        echo -e "   ìƒíƒœ: ${GREEN}ë°°í¬ë¨${NC}"
    else
        echo -e "   ìƒíƒœ: ${YELLOW}ë°°í¬ ì•ˆë¨${NC}"
    fi

    echo ""
    echo "ğŸ”§ í™˜ê²½ ë³€ìˆ˜:"
    echo "   CJ_HOME: $CJ_HOME"
    echo "   TARGET_HOST: $TARGET_HOST"
    echo "   KUBECONFIG: ${KUBECONFIG:-ì„¤ì • ì•ˆë¨}"
}

# =============================================================================
# ë¡œê·¸ í™•ì¸
# =============================================================================

cmd_logs() {
    check_kubectl
    check_cj_home

    export KUBECONFIG="$CJ_HOME/terraform/cloud-janitor-cluster-config"

    local service=$1

    case $service in
        janitor)
            log_info "Cloud Janitor ë¡œê·¸"
            kubectl logs -n default deployment/cloud-janitor -f
            ;;
        mysql)
            log_info "MySQL ë¡œê·¸"
            kubectl logs -n default statefulset/mysql -f
            ;;
        grafana)
            log_info "Grafana ë¡œê·¸"
            kubectl logs -n monitoring deployment/grafana -f
            ;;
        loki)
            log_info "Loki ë¡œê·¸"
            kubectl logs -n monitoring statefulset/loki -f
            ;;
        *)
            log_error "ì•Œ ìˆ˜ ì—†ëŠ” ì„œë¹„ìŠ¤: $service"
            echo ""
            echo "ì‚¬ìš© ê°€ëŠ¥í•œ ì„œë¹„ìŠ¤:"
            echo "   cj logs janitor   # Cloud Janitor"
            echo "   cj logs mysql     # MySQL"
            echo "   cj logs grafana   # Grafana"
            echo "   cj logs loki      # Loki"
            exit 1
            ;;
    esac
}

# =============================================================================
# ì ‘ì†
# =============================================================================

cmd_grafana() {
    log_info "Grafana ì ‘ì†: http://localhost:3000"
    
    # .env íŒŒì¼ ë¡œë“œ
    if [ -f "$CJ_HOME/.env" ]; then
        source "$CJ_HOME/.env"
        log_info "ID: admin, Password: ${GRAFANA_PASSWORD:-changeme}"
    else
        log_info "ID: admin, Password: changeme (.env íŒŒì¼ì—ì„œ GRAFANA_PASSWORD ì„¤ì •)"
    fi

    if command -v xdg-open &> /dev/null; then
        xdg-open http://localhost:3000
    elif command -v open &> /dev/null; then
        open http://localhost:3000
    else
        log_info "ë¸Œë¼ìš°ì €ë¥¼ ì§ì ‘ ì—´ì–´ì£¼ì„¸ìš”: http://localhost:3000"
    fi
}

# =============================================================================
# ê¸°íƒ€ ëª…ë ¹ì–´
# =============================================================================

cmd_env() {
    log_info ".env íŒŒì¼ í¸ì§‘"
    
    if [ ! -f "$CJ_HOME/.env" ]; then
        log_warning ".env íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤. ìƒì„±í•©ë‹ˆë‹¤..."
        cp "$CJ_HOME/.env.example" "$CJ_HOME/.env"
    fi

    ${EDITOR:-vim} "$CJ_HOME/.env"
}

cmd_kubeconfig() {
    check_cj_home
    
    local kubeconfig="$CJ_HOME/terraform/cloud-janitor-cluster-config"
    
    if [ -f "$kubeconfig" ]; then
        echo "$kubeconfig"
        log_info "ì‚¬ìš©ë²•: export KUBECONFIG=\"$kubeconfig\""
    else
        log_error "kubeconfig íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."
        exit 1
    fi
}

cmd_shell() {
    check_cj_home
    log_info "Cloud Janitor í”„ë¡œì íŠ¸ ë””ë ‰í† ë¦¬ë¡œ ì´ë™ (exitë¡œ ì¢…ë£Œ)"
    cd "$CJ_HOME"
    bash
}

# =============================================================================
# ë©”ì¸
# =============================================================================

main() {
    local command=$1
    shift || true

    case $command in
        install)
            cmd_install
            ;;
        init)
            cmd_init
            ;;
        setup)
            cmd_setup
            ;;
        start)
            cmd_start
            ;;
        stop)
            cmd_stop
            ;;
        clear)
            cmd_clear
            ;;
        tunnel)
            local subcmd=$1
            shift || true
            case $subcmd in
                setup)
                    setup_ssh_tunnel
                    ;;
                teardown|stop)
                    teardown_ssh_tunnel
                    ;;
                status)
                    if [ -f "$CJ_HOME/.ssh_tunnel_pid" ]; then
                        SSH_TUNNEL_PID=$(cat "$CJ_HOME/.ssh_tunnel_pid")
                        if ps -p "$SSH_TUNNEL_PID" > /dev/null 2>&1; then
                            log_success "SSH í„°ë„ ì‹¤í–‰ ì¤‘ (PID: $SSH_TUNNEL_PID)"
                        else
                            log_warning "SSH í„°ë„ PID íŒŒì¼ì€ ìˆì§€ë§Œ í”„ë¡œì„¸ìŠ¤ê°€ ì—†ìŠµë‹ˆë‹¤."
                        fi
                    else
                        log_warning "SSH í„°ë„ì´ ì‹¤í–‰ ì¤‘ì´ì§€ ì•ŠìŠµë‹ˆë‹¤."
                    fi
                    ;;
                *)
                    log_error "ì•Œ ìˆ˜ ì—†ëŠ” í„°ë„ ëª…ë ¹ì–´: $subcmd"
                    echo ""
                    echo "ì‚¬ìš© ê°€ëŠ¥í•œ ëª…ë ¹ì–´:"
                    echo "  cj tunnel setup    SSH í„°ë„ ìƒì„±"
                    echo "  cj tunnel stop     SSH í„°ë„ ì¢…ë£Œ"
                    echo "  cj tunnel status  SSH í„°ë„ ìƒíƒœ í™•ì¸"
                    exit 1
                    ;;
            esac
            ;;
        tf)
            cmd_tf "$@"
            ;;
        ans)
            cmd_ans "$@"
            ;;
        status)
            cmd_status
            ;;
        logs)
            cmd_logs "$@"
            ;;
        grafana)
            cmd_grafana
            ;;
        env)
            cmd_env
            ;;
        kubeconfig)
            cmd_kubeconfig
            ;;
        shell)
            cmd_shell
            ;;
        version|--version|-v)
            show_version
            ;;
        help|--help|-h|"")
            show_help
            ;;
        *)
            log_error "ì•Œ ìˆ˜ ì—†ëŠ” ëª…ë ¹ì–´: $command"
            echo ""
            show_help
            exit 1
            ;;
    esac
}


main "$@"
