#!/bin/bash

set -e

RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
BOLD='\033[1m'
NC='\033[0m'

log_info() {
    echo -e "${BLUE}[INFO]${NC} $1"
}

log_success() {
    echo -e "${GREEN}[SUCCESS]${NC} $1"
}

log_warning() {
    echo -e "${YELLOW}[WARNING]${NC} $1"
}

log_error() {
    echo -e "${RED}[ERROR]${NC} $1"
}

ROOT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
TC_DIR="$ROOT_DIR/target-cluster"
TC_SETUP="$TC_DIR/setup.sh"
TC_TEARDOWN="$TC_DIR/teardown.sh"
TC_CONNECT="$TC_DIR/setup-connection-to-cj.sh"

ensure_tc_dir() {
    if [ ! -d "$TC_DIR" ]; then
        log_error "tc 디렉토리를 찾을 수 없습니다: $TC_DIR"
        exit 1
    fi
}

usage() {
    echo -e "${BOLD}TC CLI Tool${NC}"
    echo ""
    echo -e "사용법: tc <command> [options]"
    echo ""
    echo -e "${BOLD}설치:${NC}"
    echo "  install            PATH에 tc 등록"
    echo ""
    echo -e "${BOLD}TC 관리:${NC}"
    echo "  start              TC 시작 (target-cluster/setup.sh 실행)"
    echo "  stop               TC 중지 (target-cluster/teardown.sh 실행)"
    echo "  clear              TC 전체 정리 (컨테이너 + 네트워크 + 볼륨)"
    echo "  pm start           Target Prometheus 시작"
    echo "  pm stop            Target Prometheus 중지"
    echo "  pm status          Target Prometheus 상태"
    echo "  status             TC 상태 확인"
    echo "  logs [service]     TC 컨테이너 로그"
    echo ""
    echo -e "${BOLD}cj 연결:${NC}"
    echo "  connect            TC → cj 연결 요청 전송"
    echo ""
    echo -e "${BOLD}기타:${NC}"
    echo "  help               도움말 표시"
    echo ""
    echo -e "${BOLD}예시:${NC}"
    echo "  tc install"
    echo "  tc start"
    echo "  tc stop --all"
    echo "  tc clear"
    echo "  tc connect -a localhost"
    echo "  tc status"
    echo "  tc pm start"
    echo ""
}

cmd_install() {
    local cli_path="$ROOT_DIR/tc"
    if [ ! -f "$cli_path" ]; then
        log_error "tc 스크립트를 찾을 수 없습니다: $cli_path"
        exit 1
    fi

    if [ ! -x "$cli_path" ]; then
        chmod +x "$cli_path"
    fi

    local shell_name
    shell_name="$(basename "${SHELL:-bash}")"
    local rc_file
    local profile_file

    case "$shell_name" in
        zsh)
            rc_file="$HOME/.zshrc"
            profile_file="$HOME/.zprofile"
            ;;
        bash)
            rc_file="$HOME/.bashrc"
            profile_file="$HOME/.bash_profile"
            ;;
        *)
            rc_file="$HOME/.profile"
            profile_file="$HOME/.profile"
            ;;
    esac

    touch "$rc_file"
    touch "$profile_file"

    local link_locations=(
        "/usr/local/bin/tc"
        "$HOME/.local/bin/tc"
    )

    local link_success=false
    local link_path

    for link_path in "${link_locations[@]}"; do
        local link_dir
        link_dir=$(dirname "$link_path")

        if [ ! -d "$link_dir" ]; then
            continue
        fi

        if [ ! -w "$link_dir" ]; then
            continue
        fi

        if [ -e "$link_path" ] && [ ! -L "$link_path" ]; then
            continue
        fi

        rm -f "$link_path" 2>/dev/null || true
        ln -s "$cli_path" "$link_path"
        link_success=true
        break
    done

    if ! grep -q "TC_HOME" "$rc_file" 2>/dev/null; then
        cat >> "$rc_file" << EOF
export TC_HOME="$ROOT_DIR"
export PATH="\$TC_HOME:\$PATH"
EOF
    fi

    if ! grep -q "TC_HOME" "$profile_file" 2>/dev/null; then
        cat >> "$profile_file" << EOF
export TC_HOME="$ROOT_DIR"
export PATH="\$TC_HOME:\$PATH"
EOF
    fi

    log_success "설치 완료"
    if [ "$link_success" = true ]; then
        log_info "tc 심볼릭 링크 생성 완료"
    else
        log_warning "tc 심볼릭 링크 생성 실패"
    fi
    log_info "새 터미널에서 tc 명령어를 사용할 수 있습니다."
}

cmd_start() {
    ensure_tc_dir
    if [ ! -f "$TC_SETUP" ]; then
        log_error "setup.sh를 찾을 수 없습니다: $TC_SETUP"
        exit 1
    fi
    cd "$TC_DIR"
    bash "$TC_SETUP" --apps-only "$@"
    echo ""
    log_info "다음 명령어:"
    echo "   tc pm start"
}

cmd_stop() {
    ensure_tc_dir
    if [ ! -f "$TC_TEARDOWN" ]; then
        log_error "teardown.sh를 찾을 수 없습니다: $TC_TEARDOWN"
        exit 1
    fi
    cd "$TC_DIR"
    bash "$TC_TEARDOWN" "$@"
    echo ""
    log_info "다음 명령어:"
    echo "   tc start"
}

cmd_clear() {
    ensure_tc_dir
    if [ ! -f "$TC_TEARDOWN" ]; then
        log_error "teardown.sh를 찾을 수 없습니다: $TC_TEARDOWN"
        exit 1
    fi
    cd "$TC_DIR"
    bash "$TC_TEARDOWN" --all
    echo ""
    log_info "다음 명령어:"
    echo "   tc start"
}

cmd_connect() {
    ensure_tc_dir
    if [ ! -f "$TC_CONNECT" ]; then
        log_error "setup-connection-to-cj.sh를 찾을 수 없습니다: $TC_CONNECT"
        exit 1
    fi
    cd "$TC_DIR"
    bash "$TC_CONNECT" "$@"
}

cmd_status() {
    ensure_tc_dir
    log_info "TC 컨테이너 상태 확인 중..."
    docker ps --filter "network=tc-network" --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}" || true

    if command -v curl &> /dev/null; then
        if curl -s http://localhost:9091/-/healthy > /dev/null 2>&1; then
            log_success "Prometheus 정상 (http://localhost:9091)"
        else
            log_warning "Prometheus 헬스 체크 실패 (http://localhost:9091)"
        fi
    else
        log_warning "curl이 없어 Prometheus 헬스 체크를 건너뜁니다."
    fi
}

cmd_prometheus() {
    ensure_tc_dir
    local subcmd=${1:-start}
    shift || true

    case "$subcmd" in
        start)
            if [ ! -f "$TC_SETUP" ]; then
                log_error "setup.sh를 찾을 수 없습니다: $TC_SETUP"
                exit 1
            fi
            cd "$TC_DIR"
            bash "$TC_SETUP" --prometheus-only "$@"
            echo ""
            log_info "다음 명령어:"
            echo "   cj setup"
            ;;
        stop)
            cd "$TC_DIR"
            if command -v docker-compose &> /dev/null; then
                docker-compose stop prometheus cadvisor
            else
                docker compose stop prometheus cadvisor
            fi
            log_success "Target Prometheus 중지 완료"
            echo ""
            log_info "다음 명령어:"
    echo "   tc pm start"
            ;;
        status)
            log_info "Target Prometheus 상태 확인 중..."
            docker ps --filter "name=target-prometheus" --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}" || true
            if command -v curl &> /dev/null; then
                if curl -s http://localhost:9091/-/healthy > /dev/null 2>&1; then
                    log_success "Prometheus 정상 (http://localhost:9091)"
                else
                    log_warning "Prometheus 헬스 체크 실패 (http://localhost:9091)"
                fi
            fi
            ;;
        *)
            log_error "알 수 없는 prometheus 명령어: $subcmd"
            exit 1
            ;;
    esac
}

cmd_logs() {
    ensure_tc_dir
    cd "$TC_DIR"
    if command -v docker-compose &> /dev/null; then
        docker-compose logs -f "$@"
    else
        docker compose logs -f "$@"
    fi
}

main() {
    local command=$1
    shift || true

    case "$command" in
        install)
            cmd_install
            ;;
        start)
            cmd_start "$@"
            ;;
        stop)
            cmd_stop "$@"
            ;;
        clear)
            cmd_clear
            ;;
        status)
            cmd_status
            ;;
        prometheus|pm)
            cmd_prometheus "$@"
            ;;
        connect)
            cmd_connect "$@"
            ;;
        logs)
            cmd_logs "$@"
            ;;
        help|"")
            usage
            ;;
        *)
            log_error "알 수 없는 명령어: $command"
            usage
            exit 1
            ;;
    esac
}

main "$@"
